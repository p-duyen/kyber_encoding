


%% Document
\begin{tikzpicture}[
]
\node [] (i1) at (-1, 1.75) {$\mathsf{in_1}$};
\node [] (i2) at (2.6, 1.75) {$\mathsf{in_2}$};
\node [] (i3) at (6.1, 1.75) {$\mathsf{in_7}$};

\node [mux 3by2, rotate = 0](M1) at (0, 0){};
\node [mux 3by2, rotate = 0](M3) at (3.5, 0){};
\node [mux 3by2, rotate = 0](M2) at (7, 0){};
\node [mux 2by2, rotate = 0, thick](Mo) at (10, -2.6){};


\draw [] (5, 0) \registerEn{reg1};

\node[rectangle,
minimum width = 1.2cm,
minimum height = 1.2cm,
draw] (B1) at (1.5,0) {\textsf{SBOX}};


\node[rectangle,
thick,
minimum width = 10cm,
minimum height = .4cm,
draw] (ll) at (3.5, -3) {\textsf{Linear Layer}};

\draw [-latex] (-1.5,0) -- node {\bitwidth} node [bitwidth] {16} (M1.blpin 2);

\draw [] (M2.brpin 1) -| (8.5, 2.5);
\draw [] (8.5, 2.5) -| (-1.5, 0);
\draw [thick, -latex] (ll) -- node {\bitwidth} node [bitwidth] {128} (Mo.blpin 2);

\draw [-latex] (-1,0) -- (-1, -2.75);
\draw [-latex] (2.6,0) -- (2.6, -2.75);
\draw [-latex] (6.1,0) -- (6.1, -2.75);

\draw [-latex] (-.6,-2.73) |- (M1.blpin 3);
\draw [-latex] (2.9,-2.73) |- (M3.blpin 3);
\draw [-latex] (6.4 ,-2.73) |- (M2.blpin 3);



\draw [-latex] (M1.brpin 1) -- (B1);
\draw [-latex] (B1) -- (M3.blpin 2);
\draw [-latex] (M3.brpin 1) -- (reg1);



\draw [-latex] (i1) |-  (M1.blpin 1);
\draw [-latex] (i2) |- (M3.blpin 1);
\draw [-latex] (i3) |- (M2.blpin 1);

\draw [-latex, dashed] (reg1) -- (M2.blpin 2);


\begin{scope}[yshift = -3.4cm, xshift = -1 cm]
    \node [] (tk) at (1.8, -1.58) {$\mathsf{tweakey}$};
    \draw [thick] (9, -2) \registerEn{reg2};
    \draw [thick] (12, .76) \register{reg3};

    \node [] (o) at (13, .76) {$\mathsf{out}$};
    \node [] (zero) at (10, 1.23) {$\mathsf{\{0\}}$};

    \node [mux 2by2, rotate = 0, thick](M3) at (3.25, -2){};

    \node[rectangle,
    minimum width = 1.2cm,
    minimum height = 1.2cm,
    rounded corners = 5pt,
    thick,
    draw] (P) at (6, -2) {\textsf{P}};

    \node[rectangle,
    minimum width = 1.2cm,
    minimum height = 1.2cm,
    thick,
    rounded corners = 5pt,
    draw] (LFSR) at (7.5,-2) { \textsf{LFSR}};

    \draw [-latex, thick] (M3.brpin 1) -- (P);
    \draw [-latex, thick] (P) -- (LFSR);
    \draw [-latex, thick] (4.5,-2) -- node {\bitwidth} node [bitwidthvert] {128}(4.5, 0.1);
    \draw [-latex, thick] (LFSR) -- (reg2);

    \draw [thick] (reg2) -- (10, -2);
    \draw [thick] (10,-2) |- (2.5, -3.5);
    \draw [-latex, thick] (2.5, -3.5) |- (M3.blpin 1);
    \draw [-latex, thick] (tk) -- (M3.blpin 1);
    \draw [-latex, thick] (zero) -- (Mo.blpin 1);
    \draw [-latex, thick] (reg3) -- (o);
    \draw [-latex, thick] (Mo.brpin 1) -- (reg3);

    \node[rectangle,
    dashed,
    minimum width = 6.8cm,
    minimum height = 1.9cm,
    draw] (sr) at (6.15,-2) {};
    \node [] (ll) at (6.15, -3.2) {\footnotesize\textsf{Tweakey Scheduling}};


\end{scope}

\end{tikzpicture}